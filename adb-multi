#!/bin/bash
#
#     Copyright (C) 2018 KreAch3R
#
#     Licensed under the Apache License, Version 2.0 (the "License");
#     you may not use this file except in compliance with the License.
#     You may obtain a copy of the License at
#
#          http://www.apache.org/licenses/LICENSE-2.0
#
#     Unless required by applicable law or agreed to in writing, software
#     distributed under the License is distributed on an "AS IS" BASIS,
#     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#     See the License for the specific language governing permissions and
#     limitations under the License.

# Version: 0.9

# Variables for color output
green=`tput setaf 2`
cyan=`tput setaf 6`
red=`tput setaf 1`
yellow=`tput setaf 3`
reset=`tput sgr0`

# Check for zero arguments and abort
if [ $# -eq 0 ]; then
    echo "${red}Illegal number of parameters!${reset}"
    exit 1
fi

if [ "$1" ] && [ "$1" != "generate" ]; then
    # Device ID (passed as 1st argument)
    id="$1"
elif [ "$1" == "generate" ]; then
    adb devices | while read line; do
        if [ ! "$line" = "" ] && [ `echo $line | awk '{print $2}'` = "device" ]; then
            id=$(echo $line | awk '{print $1}')
            # the problem is that adb reads from stdin by default, so you need /dev/null so that it doesn't
            # consume the rest of the loop. Read https://stackoverflow.com/a/13800476/4008886
            device=$(adb -s $id shell getprop ro.product.device </dev/null)
            #filename=$(printf '%s\n' "${model//$manufacturer/}" | sed 's/ //g')
            filename=$(echo adb-${device,,} | sed 's/ //g')
            echo "${yellow}Installing $filename...${reset}"
            cat <<EOT > ~/bin/$filename
# Autogenerated by adb-multi
# It assumes your adb-multi installation resides inside \$PATH
adb-multi "$id" "\$@"
EOT
            echo "${yellow}Installing $filename-push...${reset}"
            cat <<EOT > ~/bin/$filename-push
# Autogenerated by adb-multi
# It assumes your adb-multi installation resides inside \$PATH
adb-multi "$id" push "\$1" /sdcard
EOT
            echo "${cyan}Setting scripts as executable...${reset}"
            chmod +x ~/bin/$filename
            chmod +x ~/bin/$filename-push
        fi
    done
    echo "${green}Your device adb-multi scripts have been installed in ~/bin. Enjoy!${reset}"
    exit 0
fi

# shift passed arguments one place right
shift 1

model=$(adb -s $id shell getprop ro.product.model)
manufacturer=$(adb -s $id shell getprop ro.product.manufacturer)

echo "Connected to ${green}$manufacturer $model!${reset}"

adb -s $id $@
